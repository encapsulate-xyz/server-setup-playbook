---
- name: Install packages
  apt:
    name: 
      - rkhunter
    state: present

- name: Copy rkhunter's default config file
  copy:
    src: /etc/rkhunter.conf
    dest: /etc/rkhunter.conf.local
    remote_src: yes

- name: Ensure rkhunter log directory exists
  file:
    path: '/var/log/rkhunter'
    state: directory
    mode: '0755'
    owner: 'root'
    group: 'root'

- name:  Configure rkhunter general settings
  lineinfile:
    dest: /etc/rkhunter.conf.local
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^UPDATE_MIRRORS', line: 'UPDATE_MIRRORS=1' }
    - { regexp: '^MIRRORS_MODE', line: 'MIRRORS_MODE=0'}
    - { regexp: '^MAIL-ON-WARNING', line: 'MAIL-ON-WARNING={{ mail_to }}'}
    - { regexp: '^COPY_LOG_ON_ERROR', line: 'COPY_LOG_ON_ERROR=1'}
    - { regexp: '^PHALANX2_DIRTEST', line: 'PHALANX2_DIRTEST=1'}
    - { regexp: '^WEB_CMD', line: 'WEB_CMD=""'}
    - { regexp: '^USE_LOCKING', line: 'USE_LOCKING=1'}
    - { regexp: '^SHOW_SUMMARY_WARNINGS_NUMBER', line: 'SHOW_SUMMARY_WARNINGS_NUMBER=1'}
    - { regexp: '^LOGFILE', line: 'LOGFILE=/var/log/rkhunter/rkhunter.log'}

- name: Configure rkhunter cron job settings
  lineinfile:
    dest: /etc/default/rkhunter
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^CRON_DAILY_RUN', line: 'CRON_DAILY_RUN="true"' }
    - { regexp: '^CRON_DB_UPDATE', line: 'CRON_DB_UPDATE="true"' }
    - { regexp: '^DB_UPDATE_EMAIL', line: 'DB_UPDATE_EMAIL="false"' }
    - { regexp: '^REPORT_EMAIL', line: 'REPORT_EMAIL="root"' }
    - { regexp: '^APT_AUTOGEN', line: 'APT_AUTOGEN="true"' }
    - { regexp: '^NICE', line: 'NICE="0"' }
    - { regexp: '^RUN_CHECK_ON_BATTERY', line: 'RUN_CHECK_ON_BATTERY="false"' }

- name: Update rkhunter
  shell: |
    rkhunter --update
    rkhunter --propupd

- name: Move rkhunter script from cron.daily
  command: mv /etc/cron.daily/rkhunter /usr/local/bin/rkhunter-cron
  args:
    creates: /usr/local/bin/rkhunter-cron
    removes: /etc/cron.daily/rkhunter

- name: Ensure rkhunter-cron is executable
  file:
    path: /usr/local/bin/rkhunter-cron
    mode: '0755'

- name: Create cron job for rkhunter
  cron:
    name: "Run rkhunter every 5 minutes"
    minute: "*/5"
    job: "/usr/local/bin/rkhunter-cron"
    user: root
    